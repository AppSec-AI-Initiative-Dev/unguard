# DQL Security Query Explanation

This document explains a Dynatrace Query Language (DQL) query used to count open vulnerabilities in the Unguard application.

## Query Overview

The following DQL query counts the total number of unique open, non-muted vulnerabilities detected by Dynatrace:

```dql
fetch security.events
| filter dt.system.bucket=="default_securityevents_builtin"
     AND event.provider=="Dynatrace"
     AND event.type=="VULNERABILITY_STATE_REPORT_EVENT"
     AND event.level=="ENTITY"
// filter for the latest snapshot per entity
| dedup {vulnerability.display_id, affected_entity.id}, sort:{timestamp desc}
// filter for open non-muted vulnerabilities
| filter vulnerability.resolution.status=="OPEN"
     AND vulnerability.parent.mute.status!="MUTED"
     AND vulnerability.mute.status!="MUTED"
// count unique vulnerabilities
| summarize {`Open vulnerabilities`=countDistinctExact(vulnerability.display_id)}
```

## Detailed Explanation

### 1. Data Source Selection

```dql
fetch security.events
```

- **`fetch security.events`**: Retrieves data from Dynatrace's security events table
- This table contains all security-related events including vulnerability reports, security findings, and security state changes

### 2. Initial Filtering

```dql
| filter dt.system.bucket=="default_securityevents_builtin"
     AND event.provider=="Dynatrace"
     AND event.type=="VULNERABILITY_STATE_REPORT_EVENT"
     AND event.level=="ENTITY"
```

This filter narrows down the data to specific event types:

- **`dt.system.bucket=="default_securityevents_builtin"`**: Focuses on the default built-in security events bucket
- **`event.provider=="Dynatrace"`**: Only includes events generated by Dynatrace (excludes third-party security tools)
- **`event.type=="VULNERABILITY_STATE_REPORT_EVENT"`**: Specifically looks at vulnerability state reports
- **`event.level=="ENTITY"`**: Filters for entity-level vulnerabilities (as opposed to application or process-level)

### 3. Deduplication

```dql
| dedup {vulnerability.display_id, affected_entity.id}, sort:{timestamp desc}
```

This step ensures we get the latest state for each vulnerability:

- **`dedup {vulnerability.display_id, affected_entity.id}`**: Removes duplicate entries based on the combination of vulnerability ID and affected entity
- **`sort:{timestamp desc}`**: Sorts by timestamp in descending order (newest first) before deduplication
- **Result**: For each unique vulnerability-entity combination, only the most recent entry is kept

### 4. Status Filtering

```dql
| filter vulnerability.resolution.status=="OPEN"
     AND vulnerability.parent.mute.status!="MUTED"
     AND vulnerability.mute.status!="MUTED"
```

This filter ensures we only count active vulnerabilities:

- **`vulnerability.resolution.status=="OPEN"`**: Only includes vulnerabilities that haven't been resolved
- **`vulnerability.parent.mute.status!="MUTED"`**: Excludes vulnerabilities where the parent finding is muted
- **`vulnerability.mute.status!="MUTED"`**: Excludes vulnerabilities that have been directly muted

### 5. Aggregation

```dql
| summarize {`Open vulnerabilities`=countDistinctExact(vulnerability.display_id)}
```

The final step produces the count:

- **`summarize`**: Aggregates the filtered data
- **`countDistinctExact(vulnerability.display_id)`**: Counts unique vulnerabilities by their display ID
- **`Open vulnerabilities`**: Labels the result column

## Business Logic

This query implements the following business logic for vulnerability counting:

1. **Current State Only**: Uses deduplication to ensure only the latest state of each vulnerability is considered
2. **Active Vulnerabilities**: Only counts vulnerabilities that are currently open and not resolved
3. **Non-Muted Items**: Excludes vulnerabilities that have been muted (either directly or via parent muting)
4. **Unique Count**: Prevents double-counting by using distinct count on vulnerability display ID

## Use Cases

This query is typically used for:

- **Security Dashboards**: Displaying current vulnerability count
- **Security Metrics**: Tracking open vulnerability trends over time
- **Compliance Reporting**: Providing accurate counts for security audits
- **Operational Security**: Monitoring the security posture of applications like Unguard

## Related Documentation

- [Dynatrace DQL Documentation](https://docs.dynatrace.com/docs/platform/dynatrace-query-language)
- [Security Events Examples](https://docs.dynatrace.com/docs/shortlink/security-events-examples)
- [Unguard Security Monitoring](MONACO.md)

## Query Performance Considerations

- The `dedup` operation with sorting can be expensive on large datasets
- Consider adding time range filters if querying historical data
- The `countDistinctExact` function provides precise results but may be slower than `countDistinct` for very large datasets

## Example Output

The query returns a single row with one column:

| Open vulnerabilities |
|----------------------|
| 15                   |

This indicates there are 15 unique open, non-muted vulnerabilities currently detected in the monitored environment.