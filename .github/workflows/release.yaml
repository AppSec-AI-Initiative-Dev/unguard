name: Publish images
on:
  push:
    branches:
      - main

jobs:
  build:
    name: Publish on container registry
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Get release version
        if: startsWith(github.ref_name, 'release')
        uses: actions-ecosystem/action-regex-match@v2
        id: release-version
        with:
          text: ${{ github.ref_name }}
          regex: '^release\/v(.*)$'

      - name: Set image tag
        run: |
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV

      - name: Set image release tag
        if: ${{ steps.release-version.outputs.match != '' }}
        run: |
          echo "IMAGE_TAG=${{ steps.release-version.outputs.group1 }}" >> $GITHUB_ENV

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ vars.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache layers
        uses: actions/cache@v3
        with:
          path: "${{ github.workspace }}/.skaffold/cache"
          key: skaffold-${{ hashFiles('**/cache') }}
          restore-keys: |
            skaffold-

      - name: Run Skaffold build pipeline
        uses: hiberbee/github-action-skaffold@1.26.0
        id: build
        with:
          command: build
          skip-tests: true
          tag: ${{ env.IMAGE_TAG }}
          repository: ${{ vars.REGISTRY }}/${{ github.repository }}
          push: false

      - name: Update helm image tags
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: "tag: (.)*"
          replace: "tag: {{ env.IMAGE_TAG }}"
          include: "chart/values.yaml"

      - name: Update helm chart appVersion
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: "appVersion: (.)*"
          replace: "appVersion: {{ env.IMAGE_TAG }}"
          include: "chart/Chart.yaml"

      - name: Update helm chart version if release
        uses: jacobtomlinson/gha-find-replace@v3
        if: ${{ steps.release-version.outputs.match != '' }}
        with:
          find: "version: (.)*"
          replace: "appVersion: {{ env.IMAGE_TAG }}"
          include: "chart/Chart.yaml"

      - name: Update helm chart version if no release
        uses: jacobtomlinson/gha-find-replace@v3
        if: ${{ steps.release-version.outputs.match == '' }}
        with:
          find: "version: (.)*"
          replace: "appVersion: {{ env.IMAGE_TAG }}"
          include: "chart/Chart.yaml"

      - name: Publish Helm chart to GHCR
        run: |
          helm package chart
          helm push unguard-0.8.0.tgz oci://ghcr.io/dynatrace-oss/unguard/chart
